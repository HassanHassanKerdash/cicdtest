name: Deploy Laravel to cPanel

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # Step 1: Checkout code
      # -------------------------------
      - name: Checkout code
        uses: actions/checkout@v3

      # -------------------------------
      # Step 2: Setup PHP
      # -------------------------------
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, intl, pdo_mysql

      # -------------------------------
      # Step 3: Cache Composer dependencies
      # -------------------------------
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      # -------------------------------
      # Step 4: Install Composer dependencies
      # -------------------------------
      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      # -------------------------------
      # Step 5: Setup SSH
      # -------------------------------
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # -------------------------------
      # Step 6: Deploy to selected environments
      # -------------------------------
      - name: Deploy to cPanel
        run: |
          # Determine environment based on branch
          CURRENT_BRANCH="${{ github.ref_name }}"
          if [ "$CURRENT_BRANCH" = "main" ]; then
            ENV="live"
            BRANCH_NAME="${{ secrets.LIVE_BRANCH }}"
            SERVER_USER="${{ secrets.LIVE_SERVER_USER }}"
            SERVER_HOST="${{ secrets.LIVE_SERVER_HOST }}"
            SERVER_PORT="${{ secrets.LIVE_SERVER_PORT }}"
            SERVER_PATH="${{ secrets.LIVE_SERVER_PATH }}"
          elif [ "$CURRENT_BRANCH" = "develop" ]; then
            ENV="dev"
            BRANCH_NAME="${{ secrets.DEV_BRANCH }}"
            SERVER_USER="${{ secrets.DEV_SERVER_USER }}"
            SERVER_HOST="${{ secrets.DEV_SERVER_HOST }}"
            SERVER_PORT="${{ secrets.DEV_SERVER_PORT }}"
            SERVER_PATH="${{ secrets.DEV_SERVER_PATH }}"
          else
            echo "Unknown branch: $CURRENT_BRANCH"
            exit 1
          fi

          # Validate that all required secrets are set
          if [ -z "$BRANCH_NAME" ] || [ -z "$SERVER_USER" ] || [ -z "$SERVER_HOST" ] || [ -z "$SERVER_PORT" ] || [ -z "$SERVER_PATH" ]; then
            echo "Error: Missing required secrets for $ENV environment!"
            echo "Please ensure the following secrets are set in GitHub:"
            if [ "$ENV" = "live" ]; then
              echo "  - LIVE_BRANCH"
              echo "  - LIVE_SERVER_USER"
              echo "  - LIVE_SERVER_HOST"
              echo "  - LIVE_SERVER_PORT"
              echo "  - LIVE_SERVER_PATH"
            else
              echo "  - DEV_BRANCH"
              echo "  - DEV_SERVER_USER"
              echo "  - DEV_SERVER_HOST"
              echo "  - DEV_SERVER_PORT"
              echo "  - DEV_SERVER_PATH"
            fi
            exit 1
          fi

          echo "Deploying from branch '$CURRENT_BRANCH' to environment '$ENV'"

          deploy() {
              DEPLOY_BRANCH=$1
              DEPLOY_USER=$2
              DEPLOY_HOST=$3
              DEPLOY_PORT=$4
              DEPLOY_PATH=$5

              echo "==============================================="
              echo "Deploying branch '$DEPLOY_BRANCH' to $DEPLOY_HOST:$DEPLOY_PATH"
              echo "==============================================="

              ssh -p $DEPLOY_PORT -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST << EOF
                  set -e

                  # -------------------------------
                  # Backup current project for rollback
                  # -------------------------------
                  if [ -d "$DEPLOY_PATH" ]; then
                      TIMESTAMP=\$(date +%Y%m%d%H%M%S)
                      BACKUP_PATH="\${DEPLOY_PATH}_backup_\$TIMESTAMP"
                      echo "Backing up current project to \$BACKUP_PATH..."
                      cp -r "$DEPLOY_PATH" "\$BACKUP_PATH"
                  fi

                  # -------------------------------
                  # Navigate to project or clone repository
                  # -------------------------------
                  if [ -d "$DEPLOY_PATH/.git" ]; then
                      echo "Project exists. Fetching latest changes..."
                      cd "$DEPLOY_PATH"
                      git fetch --all
                      git reset --hard origin/$DEPLOY_BRANCH
                      git clean -fd
                  else
                      echo "Project does not exist. Cloning repository..."
                      git clone -b $DEPLOY_BRANCH https://github.com/${{ github.repository }} "$DEPLOY_PATH"
                      cd "$DEPLOY_PATH"
                  fi

                  # -------------------------------
                  # Ensure .env exists
                  # -------------------------------
                  if [ ! -f ".env" ]; then
                      if [ -f ".env.example" ]; then
                          cp .env.example .env
                          php artisan key:generate
                          echo ".env created from .env.example"
                      else
                          echo "Error: .env.example not found!"
                          exit 1
                      fi
                  fi

                  # -------------------------------
                  # Install Composer dependencies
                  # -------------------------------
                  composer install --no-dev --optimize-autoloader

                  # -------------------------------
                  # Laravel maintenance tasks
                  # -------------------------------
                  php artisan migrate --force
                  php artisan config:clear
                  php artisan route:clear
                  php artisan view:clear
                  php artisan cache:clear
                  php artisan config:cache
                  php artisan route:cache
                  php artisan view:cache
                  php artisan storage:link

                  echo "Deployment completed successfully for $DEPLOY_BRANCH."
          EOF
          }

          # -------------------------------
          # Deploy to the determined environment
          # -------------------------------
          deploy "$BRANCH_NAME" "$SERVER_USER" "$SERVER_HOST" "$SERVER_PORT" "$SERVER_PATH"

