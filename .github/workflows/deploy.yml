name: Deploy Laravel to cPanel

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      COMPOSER_PROCESS_TIMEOUT: 0
      COMPOSER_NO_INTERACTION: 1
      COMPOSER_NO_AUDIT: 1

    steps:
      # -------------------------------
      # Step 1: Checkout code
      # -------------------------------
      - name: Checkout code
        uses: actions/checkout@v3

      # -------------------------------
      # Step 2: Setup PHP
      # -------------------------------
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, intl, pdo_mysql

      # -------------------------------
      # Step 3: Cache Composer dependencies
      # -------------------------------
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      # -------------------------------
      # Step 4: Install Composer dependencies
      # -------------------------------
      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      # -------------------------------
      # Step 5: Setup SSH
      # -------------------------------
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # -------------------------------
      # Step 6: Deploy to selected environment
      # -------------------------------
      - name: Deploy to cPanel
        run: |
          CURRENT_BRANCH="${{ github.ref_name }}"

          if [ "$CURRENT_BRANCH" = "main" ]; then
            ENV="live"
            BRANCH_NAME="${{ secrets.LIVE_BRANCH }}"; BRANCH_NAME="${BRANCH_NAME:-main}"
            SERVER_USER="${{ secrets.LIVE_SERVER_USER }}"
            SERVER_HOST="${{ secrets.LIVE_SERVER_HOST }}"
            SERVER_PORT="${{ secrets.LIVE_SERVER_PORT }}"
            SERVER_PATH="${{ secrets.LIVE_SERVER_PATH }}"
          elif [ "$CURRENT_BRANCH" = "develop" ]; then
            ENV="dev"
            BRANCH_NAME="${{ secrets.DEV_BRANCH }}"; BRANCH_NAME="${BRANCH_NAME:-develop}"
            SERVER_USER="${{ secrets.DEV_SERVER_USER }}"
            SERVER_HOST="${{ secrets.DEV_SERVER_HOST }}"
            SERVER_PORT="${{ secrets.DEV_SERVER_PORT }}"
            SERVER_PATH="${{ secrets.DEV_SERVER_PATH }}"
          else
            echo "Unknown branch: $CURRENT_BRANCH"
            exit 1
          fi

          # Validate secrets
          if [ -z "$SERVER_USER" ] || [ -z "$SERVER_HOST" ] || [ -z "$SERVER_PORT" ] || [ -z "$SERVER_PATH" ]; then
            echo "⚠️  Missing required secrets for $ENV environment"
            exit 1
          fi

          echo "Deploying branch '$CURRENT_BRANCH' to environment '$ENV'"
          echo "Using deployment branch: '$BRANCH_NAME'"

          deploy() {
            DEPLOY_BRANCH=$1
            DEPLOY_USER=$2
            DEPLOY_HOST=$3
            DEPLOY_PORT=$4
            DEPLOY_PATH=$5

            echo "==============================================="
            echo "Deploying branch '$DEPLOY_BRANCH' to $DEPLOY_HOST:$DEPLOY_PATH"
            echo "==============================================="

            # Use stdin script to avoid here-document issues
            ssh -p "$DEPLOY_PORT" -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_HOST" 'bash -s' <<'DEPLOY_SCRIPT'
              set -e
              set -o pipefail
              set -x

              DEPLOY_BRANCH="$1"
              DEPLOY_PATH="$2"
              REPO="${GITHUB_REPOSITORY}"

              # Backup current project
              if [ -d "$DEPLOY_PATH" ]; then
                TIMESTAMP=$(date +%Y%m%d%H%M%S)
                BACKUP_PATH="${DEPLOY_PATH}_backup_${TIMESTAMP}"
                cp -r "$DEPLOY_PATH" "$BACKUP_PATH" || echo "Backup failed, continuing..."
              fi

              # Clone or update repository
              if [ -d "$DEPLOY_PATH/.git" ]; then
                cd "$DEPLOY_PATH"
                git fetch --all --prune
                git reset --hard "origin/$DEPLOY_BRANCH"
              else
                mkdir -p "$(dirname "$DEPLOY_PATH")"
                git clone -b "$DEPLOY_BRANCH" "https://github.com/$REPO.git" "$DEPLOY_PATH"
                cd "$DEPLOY_PATH"
              fi

              # Ensure .env exists
              [ -f ".env" ] || { cp .env.example .env || touch .env; php artisan key:generate --force || true; }

              # Install Composer dependencies
              composer install --no-dev --optimize-autoloader || true

              # Laravel maintenance
              php artisan config:cache || true
              php artisan route:cache || true
              php artisan view:cache || true
              php artisan storage:link || true

              # Permissions
              chmod -R 775 storage bootstrap/cache || true

              echo "✅ Deployment completed on server!"
            DEPLOY_SCRIPT "$DEPLOY_BRANCH" "$DEPLOY_PATH"
          }

          deploy "$BRANCH_NAME" "$SERVER_USER" "$SERVER_HOST" "$SERVER_PORT" "$SERVER_PATH"
