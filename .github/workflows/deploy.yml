name: Deploy Laravel to cPanel

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # Step 1: Checkout code
      # -------------------------------
      - name: Checkout code
        uses: actions/checkout@v3

      # -------------------------------
      # Step 2: Setup PHP
      # -------------------------------
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, intl, pdo_mysql

      # -------------------------------
      # Step 3: Cache Composer dependencies
      # -------------------------------
      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      # -------------------------------
      # Step 4: Install Composer dependencies
      # -------------------------------
      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader

      # -------------------------------
      # Step 5: Setup SSH
      # -------------------------------
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # -------------------------------
      # Step 6: Deploy to selected environments
      # -------------------------------
      - name: Deploy to cPanel
        run: |
          # Determine environment based on branch
          CURRENT_BRANCH="${{ github.ref_name }}"
          if [ "$CURRENT_BRANCH" = "main" ]; then
            ENV="live"
            # Use default "main" if LIVE_BRANCH secret is not set
            BRANCH_NAME="${{ secrets.LIVE_BRANCH }}"
            BRANCH_NAME="${BRANCH_NAME:-main}"
            SERVER_USER="${{ secrets.LIVE_SERVER_USER }}"
            SERVER_HOST="${{ secrets.LIVE_SERVER_HOST }}"
            SERVER_PORT="${{ secrets.LIVE_SERVER_PORT }}"
            SERVER_PATH="${{ secrets.LIVE_SERVER_PATH }}"
          elif [ "$CURRENT_BRANCH" = "develop" ]; then
            ENV="dev"
            # Use default "develop" if DEV_BRANCH secret is not set
            BRANCH_NAME="${{ secrets.DEV_BRANCH }}"
            BRANCH_NAME="${BRANCH_NAME:-develop}"
            SERVER_USER="${{ secrets.DEV_SERVER_USER }}"
            SERVER_HOST="${{ secrets.DEV_SERVER_HOST }}"
            SERVER_PORT="${{ secrets.DEV_SERVER_PORT }}"
            SERVER_PATH="${{ secrets.DEV_SERVER_PATH }}"
          else
            echo "Unknown branch: $CURRENT_BRANCH"
            exit 1
          fi

          # Validate that all required secrets are set (except BRANCH_NAME which has defaults)
          if [ -z "$SERVER_USER" ] || [ -z "$SERVER_HOST" ] || [ -z "$SERVER_PORT" ] || [ -z "$SERVER_PATH" ]; then
            echo "⚠️  Warning: Missing required secrets for $ENV environment!"
            echo "Skipping deployment. Please ensure the following secrets are set in GitHub:"
            if [ "$ENV" = "live" ]; then
              echo "  - LIVE_SERVER_USER (required)"
              echo "  - LIVE_SERVER_HOST (required)"
              echo "  - LIVE_SERVER_PORT (required)"
              echo "  - LIVE_SERVER_PATH (required)"
              echo "  - LIVE_BRANCH (optional, defaults to 'main')"
            else
              echo "  - DEV_SERVER_USER (required)"
              echo "  - DEV_SERVER_HOST (required)"
              echo "  - DEV_SERVER_PORT (required)"
              echo "  - DEV_SERVER_PATH (required)"
              echo "  - DEV_BRANCH (optional, defaults to 'develop')"
            fi
            echo ""
            echo "To add secrets, go to: Settings → Secrets and variables → Actions"
            echo "Workflow will continue but deployment will be skipped."
            exit 0
          fi

          echo "Deploying from branch '$CURRENT_BRANCH' to environment '$ENV'"
          echo "Using deployment branch: '$BRANCH_NAME'"

          deploy() {
              DEPLOY_BRANCH=$1
              DEPLOY_USER=$2
              DEPLOY_HOST=$3
              DEPLOY_PORT=$4
              DEPLOY_PATH=$5

              echo "==============================================="
              echo "Deploying branch '$DEPLOY_BRANCH' to $DEPLOY_HOST:$DEPLOY_PATH"
              echo "==============================================="

              ssh -p $DEPLOY_PORT -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST << EOF
                  set -e
                  set -o pipefail

                  # -------------------------------
                  # Backup current project for rollback
                  # -------------------------------
                  if [ -d "$DEPLOY_PATH" ]; then
                      TIMESTAMP=\$(date +%Y%m%d%H%M%S)
                      BACKUP_PATH="\${DEPLOY_PATH}_backup_\$TIMESTAMP"
                      echo "Backing up current project to \$BACKUP_PATH..."
                      cp -r "$DEPLOY_PATH" "\$BACKUP_PATH"
                  fi

                  # -------------------------------
                  # Navigate to project or clone repository
                  # -------------------------------
                  if [ -d "$DEPLOY_PATH/.git" ]; then
                      echo "Project exists. Fetching latest changes..."
                      cd "$DEPLOY_PATH"
                      git fetch --all
                      git reset --hard origin/$DEPLOY_BRANCH
                      git clean -fd
                  else
                      echo "Project does not exist. Cloning repository..."
                      # Create parent directory if it doesn't exist
                      PARENT_DIR="$(dirname "$DEPLOY_PATH")"
                      if [ ! -d "$PARENT_DIR" ]; then
                          echo "Creating parent directory: $PARENT_DIR"
                          mkdir -p "$PARENT_DIR" || {
                              echo "❌ Error: Failed to create parent directory: $PARENT_DIR"
                              exit 1
                          }
                      fi
                      
                      # Try HTTPS first (more reliable for public repos)
                      echo "Attempting to clone repository via HTTPS..."
                      if git clone -b $DEPLOY_BRANCH https://github.com/${{ github.repository }}.git "$DEPLOY_PATH" 2>&1; then
                          echo "✅ Repository cloned successfully via HTTPS"
                      else
                          echo "⚠️  HTTPS clone failed, trying SSH..."
                          # Try SSH as fallback
                          if git clone -b $DEPLOY_BRANCH git@github.com:${{ github.repository }}.git "$DEPLOY_PATH" 2>&1; then
                              echo "✅ Repository cloned successfully via SSH"
                          else
                              echo "❌ Error: Failed to clone repository using both HTTPS and SSH"
                              echo "Please check:"
                              echo "  1. Repository URL is correct"
                              echo "  2. Branch '$DEPLOY_BRANCH' exists"
                              echo "  3. Repository is accessible"
                              exit 1
                          fi
                      fi
                      cd "$DEPLOY_PATH" || {
                          echo "❌ Error: Failed to change directory to $DEPLOY_PATH"
                          exit 1
                      }
                  fi

                  # -------------------------------
                  # Ensure .env exists
                  # -------------------------------
                  if [ ! -f ".env" ]; then
                      if [ -f ".env.example" ]; then
                          cp .env.example .env
                          php artisan key:generate
                          echo ".env created from .env.example"
                      else
                          echo "⚠️  Warning: .env.example not found. Creating .env from scratch..."
                          touch .env
                          php artisan key:generate
                          echo ".env created successfully"
                      fi
                  else
                      echo ".env file already exists, skipping creation"
                  fi

                  # -------------------------------
                  # Install Composer dependencies
                  # -------------------------------
                  composer install --no-dev --optimize-autoloader

                  # -------------------------------
                  # Laravel maintenance tasks
                  # -------------------------------
                  php artisan migrate --force
                  php artisan config:clear
                  php artisan route:clear
                  php artisan view:clear
                  php artisan cache:clear
                  php artisan config:cache
                  php artisan route:cache
                  php artisan view:cache
                  php artisan storage:link

                  echo "Deployment completed successfully for $DEPLOY_BRANCH."
          EOF
          }

          # -------------------------------
          # Deploy to the determined environment
          # -------------------------------
          deploy "$BRANCH_NAME" "$SERVER_USER" "$SERVER_HOST" "$SERVER_PORT" "$SERVER_PATH"

